# API Blueprint Language Server

Пакет позволяет более удобно работать с API Blueprint в редакторах кода и IDE.

## Возможности

* подсветка синтаксиса;
* переход к определению структур данных и Resource Prototypes;
* хлебные крошки;
* автодополнение.

## Работа с многофайловой документацией

Часто проекты содержат не один файл, а несколько. В этом случае можно
определить структуры данных в одном файле, а использовать их в другом. При
этом для корректной работы плагину необходимо знать корневой файл от которого
собирать документацию. В противном случае плагин не сможет понять какие
структуры данных являются корректными, а какие не определены.

По умолчанию, плагин пытается найти файл `doc.apib` в корне проекта и
использовать его в качестве корня. Если такой файл не найден, то документация
считается однофайловой.

Если в проекте в качестве корневого используется файл отличный от `doc.apib`,
то об этом можно сообщить плагину с помощью настройки:

File -> Prefernces -> Settings -> Extensions -> API Blueprint -> Entry Point

Если по каким-то причинам в файле не подсвечиваются ошибки, то первое, что надо
проверить — подключается ли данный файл прямо или опосредованно в корень
проекта.

## Структура пакета

```
├── client // Language Client
    └── extension.js // Language Client entry point
├── package.json // The extension manifest.
└── server // Language Server
    └── server.js // Language Server entry point
```

## Запуск для разработки в VS Code

* в корневой директории выполнить команду `npm install`;
* открыть VS Code;
* переключиться в Debug viewlet;
* запустить `Launch Client`;
* открыть проект с APIB документацией или отдельный APIB-файл;
* запустить `Attach to Server`.

Вместо отдельных шагов `Launch Client` и `Attach to Server` можно использовать
команду `Client + Server`, но тогда APIB-файл нужно открывать достаточно
быстро, иначе команда `Attach to Server` завершится с ошибкой.

## Отладка

Для отладки сервера можно использовать точки останова и отладочный вывод.

Для отладочного вывода можно использовать функцию `connection.console.log`. При
этом результаты вывода необходимо искать в окне `Extension Development Host` в
панели `Output` - `API Blueprint Language Server`.

## Сборка расширения для VS Code

* в корневой директории выполнить команду `npx vsce package`;
* полученный пакет передать для установки заинтересованным лицам.

## Работа с LS в WebStorm, PhpStorm и пр.

### Добавление поддержки Language Server Protocol

Для работы с LS необходимо установить плагин
[LSP Support](https://plugins.jetbrains.com/plugin/10209-lsp-support).

Последняя версия плагина (1.6.1) работает крайне не стабильно, а разработка
приостановлена на неопределённый срок, поэтому рекомендуется установить версию
[1.6.0](https://github.com/gtache/intellij-lsp/releases/tag/v1.6.0).   

Установка:

1. Скачать архив
   [LSP.zip](https://github.com/gtache/intellij-lsp/releases/download/v1.6.0/LSP.zip).
2. Перейти в раздел с плагинами в настройках IDE
   (Preferences → [Plugins](jetbrains://WebStorm/settings?name=Plugins)).
3. Нажать на иконку шестерёнки и выбрать пункт «Install Plugin from Disk…».
4. Указать путь до файла LSP.zip.

После успешной установки файл LSP.zip можно удалить.

### Настройка плагина LSP Support

Настройка плагина производится по пути Preferences → Languages & Frameworks → Language Server Protocol →
[Server Definitions](jetbrains://WebStorm/settings?name=Languages+%26+Frameworks--Language+Server+Protocol--Server+Definitions).

Необходимо установить следующие настройки:

1. В выпадающем меню выбрать: `Executable`.
2. В поле Extension указать: `apib`.
3. В поле Path указать полный путь до исполняемого файла `node`.
4. В поле Args первым аргументом указать полный путь до файла
   [server/server.js](./server/server.js), а вторым, через пробел,
   добавить текст `--stdio`. Пример:
   `/full/path/to/vscode-apib-ls/server/server.js --stdio`.
   
Так же возможен вариант настройки с глобальной установкой LS в виде исполняемого
файла.

Для этого необходимо в директории проекта выполнить команду `npm link`, после
чего убедиться в том, что из терминала доступен вызов команды `apibserver`.

Затем, в настройках плагина, в поле Path изменить значение на `apibserver`,
а в поле Args на `--stdio`.

**Важно**. После любых изменений настроек плагина лучше перезагрузить IDE.
